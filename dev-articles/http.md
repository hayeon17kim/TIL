# HTTP 컨텐츠 협상

HTTP에서 *컨텐츠 협상*이란 **동일한 URI에서 리소스의 서로 다른 버전을 서브하기 위해 사용되는 메커니즘**으로, 사용자 에이전트가 사용자에게 제일 적절한 것이 무엇인지(ex: 문서 언어, 이미지 포맷, 컨텐츠 인코딩 등)를 명시할 수 있다.

## 컨텐츠 협상의 원칙

클라이언트는 리소스의 URL을 사용해 리소스를 요청한다. 서버는 **리소스의 변형들**(**프레젠테이션**) 중 하나를 선택하기 위해서 URL을 사용하고, 클라이언트에게 해당 리소스의 특정 프레젠테이션을 반환한다. 프레젠테이션들에 더해, 전체 리소스들은 특유의 URL을 가진다. **리소스가 호출됐을 때 특정 프레젠테이션을 선택하는 방법**은 *컨텐츠 협상*에 의해 **결정**된다. 컨텐츠 협상은 서버 주도 협상과 에이전트 주도 협상으로 나뉘어진다.

![img](https://mdn.mozillademos.org/files/13789/HTTPNego.png)

## 서버 주도 컨텐츠 협상

**클라이언트가 보내는 특정 HTTP 헤더를 이용**하는 방법으로, 특정 종류의 리소스에 대한 **표준 협상 방법**이다. 

사용자 에이전트는 URL을 이용해 사용자의 우선적 선택을 나타내는 HTTP 헤더를 전송한다. 서버는 그것들을 힌트로 사용하고, 내부 알고리즘은 클라이언트로 서브하기 위한 최선의 컨텐츠를 선택하게 된다. 이 알고리즘은 서버 특유의 것이며 표준으로 정의된 것은 아니다.

![img](https://mdn.mozillademos.org/files/13791/HTTPNegoServer.png)

HTTP/1.1 표준은 서버 주도 협상을 시작하는 표준 헤더 목록([`Accept`](https://developer.mozilla.org/ko/docs/Web/HTTP/Headers/Accept), [`Accept-Charset`](https://developer.mozilla.org/ko/docs/Web/HTTP/Headers/Accept-Charset), [`Accept-Encoding`](https://developer.mozilla.org/ko/docs/Web/HTTP/Headers/Accept-Encoding), [`Accept-Language`](https://developer.mozilla.org/ko/docs/Web/HTTP/Headers/Accept-Language))을 정의하고 있다. 서버는 실제로 컨텐츠 협상에 있어 어떤 헤더가 사용될 지 (더 엄밀히 말하자면 연관된 응답 헤더) 가리키기 위해 [`Vary`](https://developer.mozilla.org/ko/docs/Web/HTTP/Headers/Vary) 헤더를 사용하므로 [캐시](https://developer.mozilla.org/en-US/docs/Web/HTTP/Caching)는 최적으로 동작하게 된다. 이 외에도 클라이언트 힌트라는 사용자가 사용하는 기기가 무엇인지 알려주는 헤더도 이 리스트에 추가하려는 움직임이 있다.

서버 주도 컨텐츠 협상은 리소스의 특정 프레젠테이션을 선택하는 가장 일반적인 방법이지만, 단점이 존재한다:

- 서버는 브라우저 수용 능력에 대해 완벽히 알고 있지 않기 때문에 서버 선택은 다소 임의적이다.
- 클라이언트 헤더에 있는 정보는 사생활 침해가 될 수 있다.
- 주어진 리소스의 몇몇 프레젠테이션이 전송되므로, 샤드된 캐시들은 덜 효율적이며 서버 구현은 좀 더 복잡해진다.

> 샤드: 단일의 데이터를 조각내어 나누는 것을 말한다.

### `Accept` 헤더

`Accept` 헤더는 에이전트가 처리하고자 하는 미디어 리소스의 MIME 타입을 나한 목록이다. 다른 MIME 타입과의 상대적인 선호도를 나타낸다. 브라우저나 다른 에이전트에 의해 정의되며, 컨텍스트에 따라 다양해질 수 있다.

### `Accept-CH` 헤더 

*클라이언트 힌트*라고 불리는 다소 **실험적인** 기술의 일부로 현재 크롬 46과 그 이후 버전에서만 구현되어 있다. 이 헤더는 **적합한 응답을 선택**하기 위해 서버가 사용할 수 있는 설정 데이터를 나열한다.

| 값               | 의미                               |
| :--------------- | :--------------------------------- |
| `DPR`            | 클라이언트 기기의 픽셀 비율(ratio) |
| `Viewport-Width` | CSS 픽셀에서의 레이아웃 뷰포트     |
| `Width`          | 이미지 고유 사이즈                 |

### `Accept-Charset` 헤더

사용자 에이너트가 어떤 종류의 문자 인코딩을 이해할 수 있는지 서버에게 알려준다. 예전에 클라이언트 지역에 따라 서로 다른 값을 설정하는데 사용되어 왔다. 그러나  UTF-8이 잘 지원되고 사용되는 지금은 개인정보를 보장하기 위해 대부분의 브라우저들은 `Accept-Charset` 헤더를 생략하고 있다.

### `Accept-Encoding` 헤더

수용 가능한 (압축을 지원하는) 컨텐츠 인코딩을 정의하고 있다. 값은 인코딩 값의 우선 순위를 가리키는 q 인자 목록(예를 들어, : `br, gzip;q=0.8`)이다. 기본값 `identity`는 가장 낮은 우선 순위이다(선언된 것이 없는 경우).

HTTP 메시지 압축은 웹 사이트의 성능을 높이는 가장 중요한 방법이며, 전송 데이터의 크기를 줄여주며 가용할 수 있는 대역폭을 더 좋은 상태로 만들어줍니다; 브라우저는 항상 이 헤더를 전송하며 서버는 그것을 받아들이고 압축을 사용하도록 구성되어 있어야 합니다.

### `Accept-Language` 헤더

사용자가 선호하는 언어를 가리키는데 사용된다. 그것은 품질 인자를 가진 값 목록입니다(`"de, en;q=0.7`"). 기본 값은 사용자 에이전트의 그래픽 인터페이스 언어와 관련하여 설정되지만, 대부분의 브라우저들은 다른 언어 설정을 허용한다.

그러나 웹 사이트는 사용자의 실제 요구를 반영하기 위해 이 값이 불일치할 수 있다 따라서 사이트의 메인 페이지에서만 이 헤더를 사용하여 사이트를 보여주되, 서버에서 선택한 언어가 아닌 다른 언어를 선택할 수 있는 방법을 제공해야 한다. (ex: 사이트에 언어 메뉴 제공)

### `User-Agent` 헤더

요청을 전송하는 브라우저를 식별하게 해준다. *제품 토큰(product tokens)*과 *코멘트* 목록으로 구성된다. *제품 토큰(product token)*은 `Firefox/4.0.1`처럼 브라우저 이름 뒤에 '`/`'와 버전 번호가 오는 이름이다. 

> 이 헤더에 의지해 브라우저마다 다른 웹 페이지 또는 서비스를 제공하는 것은 나쁜 생각이다. 웹은 사용자가 어떤 브라우저나 디바이스를 사용하는 지에 개의치 않고 모두에게 접근이 용이해야 하기 때문이다.

### `Vary` 응답 헤더

클라이언트에 의해 전송되는 `Accept-*` 헤더들과는 달리, [`Vary`](https://developer.mozilla.org/ko/docs/Web/HTTP/Headers/Vary) HTTP 헤더는 웹 서버에 의한 응답 내로 전달된다. 이 헤더는 **서버 주도 컨텐츠 협상의 과정 중에 서버에 의해 사용되는 헤더들의 목록**을 나타낸다. 이 헤더는 결정 기준 캐시를 알리기 위해 필요하므로 사용자에게 잘못된 컨텐츠를 제공하는 일을 방지하는 동안 캐시가 가동되게 허용하도록 캐시를 복제할 수 있다. '`*`'은 서버 주도 컨텐츠 협상이 적합한 컨텐츠 선택을 위해 헤더로 전달되지 않은 정보도 사용한다는 것을 의미한다.

`Vary` 헤더로 인해 캐시를 적절하게 동작하도록 허용하는 일이 필요 없게 되었다.  **캐시**는, **에이전트 주도 컨텐츠 협상과 함께 동작하도록 하기 위해, 전송된 컨텐츠를 선택하도록 서버에 의해 사용되었던 기준이 어떤 것인지 알 필요**가 있습니다. 그런 방법으로, 캐시는 알고리즘을 재연할 수 있으며 서버에 추가적인 요청없이도 수용 가능한 컨텐츠를 직접 서브할 수 있게 될 것입니다. 확실히, 캐시는 무슨 요소가 뒤에 있는지 알 수 없으므로, '`*`' 와일드카드는 현재 일어나고 있는 일들로부터 캐시되는 것을 방지합니다.

## 에이전트 주도 협상

에이전트 주도 협상, 즉 리액트 협상은 서버에 의해 전달되는 300 (다중 선택) 혹은 406(허용되지 않음) **HTTP 응답 코드를 이용**하는 방법으로, 폴백 메커니즘으로써 사용된다.

서버 주도 협상은 확장하기가 용이하지 않다. 협상 내에서 사용하는 기능 당 한 가지 헤더가 존재해야 한다. 만약 스크린 크기, 해상도 혹은 또 다른 치수를 사용하고자 한다면, 새로운 HTTP 헤더가 만들어져야 한다. 헤더는 모든 요청 상에서 전송되어야 하는데, 메시지 사이즈가 커져 성능이 저하될 수 있다. 한편, 정확한 헤더가 전송되면 전송될수록, 좀 더 많은 HTTP 흔적과 그와 관련된 개인정보들이 남게 된다.

이에 HTTP는 초창기부터 *에이전트 주도 협상* 을 허용했다. 에이전트 주도 협상에서 서버에 애매모호한 요청이 들어왔을 때, **사용 가능 리소스들의 링크를 포함한 페이지(300 Multiple Choices)를 리턴**하고, 이에 **사용자는 사용하고자 하는 리소스를 선택**한다.

![img](https://mdn.mozillademos.org/files/13795/HTTPNego3.png)

**에이전트 주도 협상의 문제점**

- HTTP 표준은 사용 가능한 리소스 중에서 선택하도록 허용하는 페이지의 형식을 명시하지 않고 있다. 게다가 이 방법은 스크립팅, 특히 자바스크립트 리다이렉션과 함께 사용된다.

- 실제 리소스를 가져오는데 한 개 이상의 요청이 필요로 해서, 사용자에 대한 리소스 효용성이 떨어진다.