---
title: "💻 HTTP #7: HTTP 압축"
categories: network
tags: [ network, http ]
---


압축은 웹 사이트의 성능을 높여주는 방법 중 하나이다. 어떤 문서에 대해서는 70% 이상의 사이즈 축소로 대역폭 용량을 낮춰주는 효과를 가져다준다. 브라우저와 서버가 이미 압축 메커니즘을 잘 구현하고 있기 때문에, 웹 개발자는 구현할 필요 없이 서버가 잘 구성되어 있는지 확인만 하면 된다.

압축은 세 개의 서로 다른 계층에서 이뤄진다.

- 먼저 일부 파일 형식이 최적화된 특유의 방법으로 압축
- HTTP 계층에서 일반적인 암호화
- HTTP 커넥션의 두 노드 사이의 커넥션 계층에서 압축이 정의된다.

## 파일 포맷 압축

각 데이터 타입은 내부적으로 중복을 가지고 있다. 텍스트가 60%의 중복을 가지고 있다면, 오디오 및 비디오 같은 미디어의 경우 중복 비율이 일반적으로 더 높다. 따라서 특정 목적을 위해 설계된 파일 포맷이 사용하는 최적화 알고리즘이 등장했다.

### 무손실 압축

압축-비압축 사이클이 복원 데이터를 변경하지 않는다. (gif, png)

### 손실 압축

사용자가 인지하기 어려운 이내에서 사이클이 원본 데이터를 변경한다. (웹의 비디오, jpeg)


- 손실 압축 알고리즘이 무손실 압축 알고리즘보다 효율적이다.
- 도구가 만들어 낸 이미지는 웹에 최적화되지 않을 수 있다. 
- 사이트의 더 나은 성능을 위해 품질을 지키면서도 가능한 많이 압축하는 것이 이상적이다. 
- 압축은 특정 종류의 파일에서 더 잘 동작하기 때문에 파일을 두 번 압축하는 것은 도움이 되지 않는다.
- 보통 압축을 할 때의 오버헤드 비용이 이득보다 크기 때문에 생산성 문제가 발생한다.

> 오버헤드? 어떤 처리를 하기 위해 들어가는 간접적인 처리 시간/메모리 등을 말한다.



## 종단 간 압축	

![img](https://mdn.mozillademos.org/files/13801/HTTPEnco1.png)

- 웹 사이트의 가장 큰 **성능 이득**이 발생하는 구간이다.
- 서버에 의해 처리되고 클라이언트에 도달할 때까지 변하지 않는 메시지 바디의 압축을 나타낸다.
- 모든 모던 브라우저와 서버는 종단 간 압축을 지원하고, 단지 압축 알고리즘만을 설정하면 된다. 
- 종단 간 압축에서는 보통 텍스트에 최적화된 압축 알고리즘을 사용한다. 
  - 가장 일반적인`gzip`과 최근 등장한 `br`이 사용하기 적절하다.

![img](https://mdn.mozillademos.org/files/13811/HTTPCompression1.png)

사용할 알고리즘을 선택하기 위해 브라우저와 서버는 **Content-Negotiation**을 사용한다.
- 브라우저: **브라우저가 지원하는 알고리즘**과 그 우선순위와 함께 `Accept-Encoding` 헤더를 전송한다.
- 서버: 요청의 헤더를 뽑아내서 **응답 바디를 압축하는 데 사용**하고, **서버가 선택한 알고리즘을 `Content-Encoding` 헤더를 사용해 브라우저에게 알려준다**. 이때, 컨텐츠 협상이 인코딩에 근거한 표현을 선택하는 데 사용되므로 적어도 `Cotnent-Encoding`에 포함되는 하나의 `Vary` 헤더가 반드시 응답 내 헤더에 포함되어야 한다. 



- 종단 간 압축 단계에서는 이미 미디어 파일들은 압축되어 있을 것이다.

## Hop-by-hop 압축

![img](https://mdn.mozillademos.org/files/13807/HTTPTE1.png)

![img](https://mdn.mozillademos.org/files/13809/HTTPComp2.png)

- 종단간 압축과 비슷하긴 하지만, 서버에서 리소스에 대한 압축이 일어나지 않고 **클라이언트와 서버의 경로 상**에 있는 어떤 두 **노드 사이**에서 메세지의 바디에 압축이 일어난다. 
- 요청을 전송하는 노드는 노드 요청이 `TE` 헤더를 사용하고 있다는 것을 알려 줘야 한다. 다른 노드들은 알맞은 방법을 선택하여 적용하고 `Transfer-Encoding` 헤더를 사용해 선택한 내용을 가리킨다.
- Hop 압축은 서버와 클라이언트에게 보이지 않고, 드물게 사용된다.
- Hop 층에서 Transfer-Encoding 헤더와 압축 사용은 보통 프록시 계층에 적용된다.



출처: https://developer.mozilla.org/ko/docs/Web/HTTP/Compression